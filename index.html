<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LOGIN OTP</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    body {
      margin: 0; padding: 0;
      background: url("https://api3.duniadigitalsb.my.id/muhni/dor/backend.php?action=produk") no-repeat center center fixed;
      background-size: cover; min-height: 100vh;
      display: flex; justify-content: center; align-items: center;
      padding: 20px;
    }
    .card {
      background: white; border-radius: 18px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      width: 100%; max-width: 420px;
      overflow: hidden; animation: fadeIn 0.5s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .form { padding: 20px; }
    label { font-size: 0.9rem; margin-top: 10px; display: block; }
    input[type="tel"] {
      width: 100%; padding: 12px; font-size: 1rem; margin-top: 6px;
      border: 1px solid #ccc; border-radius: 10px; background: #f9f9f9;
      outline: none; transition: border-color 0.3s, box-shadow 0.3s;
    }
    input:focus {
      border-color: #1565c0; box-shadow: 0 0 0 3px #1565c033;
    }
    button {
      width: 100%; padding: 14px; margin-top: 16px; font-weight: 600;
      font-size: 1rem; background: #1565c0; color: white;
      border: none; border-radius: 10px; cursor: pointer;
      transition: background 0.3s;
    }
    button:hover { background: #003f8a; }
    .result {
      margin: 0 20px 12px; padding: 14px;
      background: #fafafa; border: 1px solid #ddd;
      border-radius: 10px; font-size: 0.85rem; white-space: pre-wrap;
    }
    .spinner {
      width: 30px; height: 30px; border: 4px solid #ddd;
      border-top: 4px solid #1565c0; border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 14px auto; display: none;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .info {
      background: #f0f8ff; padding: 10px; border-left: 4px solid #1565c0;
      font-size: 0.85rem; margin: 10px 0; border-radius: 6px;
    }
    .access-token {
      background: #e8f5e9; color: red; margin: 0 20px 10px;
      padding: 8px 12px; border-radius: 6px; font-size: 0.85rem;
      word-break: break-all;
    }
    .toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: #4caf50; color: white; padding: 10px 18px;
      border-radius: 6px; font-size: 0.9rem; z-index: 9999;
      display: none; animation: fadeInOut 3s ease forwards;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(-10px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; }
      100% { opacity: 0; transform: translateY(-10px); }
    }
  </style>
</head>
<body>
<div class="toast" id="toastMsg">Access token berhasil disalin!</div>

<div class="card">
  <div class="form">
    <label>Nomor HP</label>
    <input type="tel" id="nomorOtp" placeholder="628xxx">
    <div class="info">
      Masukkan nomor XL/AXIS lalu klik <b>Minta OTP</b> untuk verifikasi.
    </div>
    <button onclick="mintaOTP()">Minta OTP</button>

    <label>Kode OTP</label>
    <input type="tel" id="kode_otp" placeholder="123456">
    <button onclick="loginOTP()">Login OTP</button>
  </div>

  <div class="spinner" id="spinner"></div>
  <div class="result" id="hasilBox">Respon akan tampil di sini...</div>
  <div id="accessBox" class="access-token" style="display:none;"></div>
  <div style="padding: 0 20px 20px">
    <button onclick="salinToken()">üìã Salin Access Token</button>
  </div>
</div>

<script>
const API_URL = "https://api3.duniadigitalsb.my.id/muhni/kmsp/otp.php";

function bersihkanNomor(input) {
  return input.replace(/[^0-9]/g, '').replace(/^0+/, '62').replace(/^\+?62+/, '62');
}

function tampilkanLoading() {
  document.getElementById("spinner").style.display = "block";
  document.getElementById("hasilBox").textContent = "Memproses...";
}

function tampilkanHasil(text) {
  document.getElementById("spinner").style.display = "none";
  document.getElementById("hasilBox").textContent = text;
}

function mintaOTP() {
  const nomor = bersihkanNomor(document.getElementById("nomorOtp").value);
  if (!nomor.startsWith("628")) return tampilkanHasil("‚ùå Format nomor salah.");

  tampilkanLoading();
  fetch(`${API_URL}?action=request_otp&number=${nomor}`)
    .then(res => res.json())
    .then(data => {
      if (data.status && data.data?.auth_id) {
        localStorage.setItem("auth_id", data.data.auth_id);
        tampilkanHasil("‚úÖ OTP dikirim. Silakan cek SMS kamu!");
      } else {
        tampilkanHasil("‚ùå " + (data.message || "Gagal request OTP"));
      }
    })
    .catch(err => tampilkanHasil("‚ùå Error: " + err.toString()));
}

function loginOTP() {
  const nomor = bersihkanNomor(document.getElementById("nomorOtp").value);
  const otp = document.getElementById("kode_otp").value.trim();
  const auth_id = localStorage.getItem("auth_id");

  if (!auth_id) return tampilkanHasil("‚ùå auth_id tidak ditemukan. Minta OTP dulu.");
  if (!otp || otp.length < 4) return tampilkanHasil("‚ùå Masukkan kode OTP yang benar.");

  tampilkanLoading();
  fetch(`${API_URL}?action=login_otp&number=${nomor}&auth_id=${auth_id}&otp=${otp}`)
    .then(res => res.json())
    .then(data => {
      if (data.status && data.data?.access_token) {
        localStorage.setItem("access_token", data.data.access_token);
        localStorage.removeItem("auth_id");
        tampilkanHasil(`‚úÖ Login berhasil!\nüîë Access token disimpan.`);
        document.getElementById("accessBox").textContent = "üîë Access Token:\n" + data.data.access_token;
        document.getElementById("accessBox").style.display = "block";
      } else {
        tampilkanHasil("‚ùå " + (data.message || "Login OTP gagal"));
      }
    })
    .catch(err => tampilkanHasil("‚ùå Error: " + err.toString()));
}

function salinToken() {
  const token = localStorage.getItem("access_token");
  if (!token) return alert("Access token belum tersedia.");

  navigator.clipboard.writeText(token).then(() => {
    const toast = document.getElementById("toastMsg");
    toast.style.display = "block";
    setTimeout(() => toast.style.display = "none", 3000);
  }).catch(() => {
    alert("‚ùå Gagal menyalin token.");
  });
}
// Tampilkan access token saat halaman dibuka jika tersedia
window.addEventListener("DOMContentLoaded", () => {
  const token = localStorage.getItem("access_token");
  const box = document.getElementById("accessBox");

  if (token) {
    box.textContent = token;
    box.style.display = "block";
  } else {
    box.textContent = "Belum ada access token";
    box.style.display = "block";
  }
});

</script>
</body>
</html>
