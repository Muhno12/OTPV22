<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login OTP Buyer</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"/>
  <style>
    /* Global Styles */
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #f39c12, #e74c3c, #8e44ad);
      animation: gradient 10s ease infinite;
      margin: 0;
      padding: 0;
    }
    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 100%;
      text-align: center;
    }
    h2 { font-size: 28px; margin-bottom: 10px; color: #333; }
    h4 { font-size: 16px; margin-bottom: 20px; color: #666; }
    input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
      transition: border-color 0.3s;
    }
    input:focus { border-color: #667eea; outline: none; }
    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background-color: #667eea;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
      margin-bottom: 10px;
    }
    button:hover { background-color: #556cd6; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="container">
    <h2>LOGIN OTP BUYER</h2>
    <h4>SOLUSI CEPAT TANPA ANTRE PROSES OTP KE SELLER</h4>
    <form id="otpForm">
      <input type="tel" id="phone" name="phone" placeholder="Masukkan Nomor Telepon" required>
      <button type="button" id="btnRequestOTP" onclick="requestOTP()">Kirim OTP</button>
      <input type="text" id="otp" name="otp" placeholder="Masukkan OTP" required disabled>
      <button type="button" id="btnVerifyOTP" onclick="verifyOTP()" disabled>Verifikasi OTP</button>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
  <script>
    // Fungsi generateUUID menggunakan crypto API
    function generateUUID() {
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      );
    }
    
    // Setiap sesi halaman mendapatkan UUID random yang unik
    const uuid = generateUUID();

    // Fungsi formatPhone: jika nomor diawali "08", ubah menjadi "628"
    function formatPhone(phone) {
      return phone.trim().replace(/^08/, "628");
    }

    let isRequestOTPInProgress = false;
    let isVerifyOTPInProgress = false;
    // Endpoint API yang dituju (ubah sesuai kebutuhan)
    const apiURL = "https://api.apii.biz.id/api/otp";

    function requestOTP() {
      const phoneInput = document.getElementById('phone');
      let phone = phoneInput.value.trim();
      
      if (!phone) {
        Swal.fire("Error", "Silakan isi nomor telepon terlebih dahulu", "error");
        return;
      }
      
      let formattedPhone = formatPhone(phone);
      phoneInput.value = formattedPhone;
      
      if (!formattedPhone.startsWith("628")) {
        Swal.fire("Error", "Nomor telepon harus diawali dengan 628", "error");
        return;
      }
      
      if (isRequestOTPInProgress) return;
      isRequestOTPInProgress = true;
      
      const requestBtn = document.getElementById('btnRequestOTP');
      requestBtn.disabled = true;
      requestBtn.innerHTML = "Memproses...";
      
      const payload = {
        phone: formattedPhone,
        uuid: uuid,
        apikey: '803f89e8-1584-41ce-a4cf-5980049433ee'
      };
      
      fetch(apiURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          Swal.fire('OTP Dikirim', 'OTP berhasil dikirim', 'success');
          document.getElementById('otp').disabled = false;
          document.getElementById('btnVerifyOTP').disabled = false;
          // Pertahankan nomor telepon di input agar tidak diubah
          phoneInput.disabled = true;
        } else if (data.status === 'error') {
          Swal.fire('Error', data.message || 'Gagal mengirim OTP', 'error');
        } else {
          Swal.fire('Error', 'Respon tidak dikenali', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'Terjadi kesalahan saat request OTP', 'error');
      })
      .finally(() => {
        isRequestOTPInProgress = false;
        requestBtn.disabled = false;
        requestBtn.innerHTML = "Kirim OTP";
      });
    }

    function verifyOTP() {
      const otpInput = document.getElementById('otp');
      let otp = otpInput.value.trim();

      if (!otp) {
        Swal.fire("Error", "Silakan isi OTP terlebih dahulu", "error");
        return;
      }

      if (isVerifyOTPInProgress) return;
      isVerifyOTPInProgress = true;

      const verifyBtn = document.getElementById('btnVerifyOTP');
      verifyBtn.disabled = true;
      verifyBtn.innerHTML = "Memverifikasi...";

      const phone = formatPhone(document.getElementById('phone').value.trim());

      const payload = {
        phone: phone,
        otp: otp,
        uuid: uuid,
        apikey: '803f89e8-1584-41ce-a4cf-5980049433ee'
      };

      fetch(apiURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          Swal.fire({
            title: 'Berhasil Login',
            text: data.message,
            icon: 'success',
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false
          });
        } else if (data.status === 'error') {
          Swal.fire('Gagal Login', data.message || 'Gagal verifikasi OTP', 'error');
        } else {
          Swal.fire('Gagal Login', 'Respon tidak dikenali', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'Terjadi kesalahan saat verifikasi OTP', 'error');
      })
      .finally(() => {
        isVerifyOTPInProgress = false;
        verifyBtn.disabled = false;
        verifyBtn.innerHTML = "Verifikasi OTP";
      });
    }
    
     // Blokir klik kanan (context menu)
    document.addEventListener('contextmenu', function(s) {
      e.preventDefault();
    });

    // Blokir shortcut DevTools
    document.onkeydown = function(e) {
      if (e.ctrlKey && e.shiftKey && e.keyCode === 'I'.charCodeAt(0)) return false;
      if (e.ctrlKey && e.shiftKey && e.keyCode === 'C'.charCodeAt(0)) return false;
      if (e.ctrlKey && e.shiftKey && e.keyCode === 'J'.charCodeAt(0)) return false;
      if (e.ctrlKey && e.keyCode === 'U'.charCodeAt(0)) return false;
    };

    // Blokir properti eruda
    Object.defineProperty(window, 'eruda', {
      get: function() {
        alert('MAU NGAPAIN HAYOO!!');
        window.location.href = "about:blank";
      },
      set: function() {
        alert('MAU NGAPAIN HAYOO!!');
        window.location.href = "about:blank";
      }
    });

    // Deteksi script 'eruda'
    const originalAppendChild = Element.prototype.appendChild;
    Element.prototype.appendChild = function(node) {
      if (node.tagName === 'SCRIPT' && node.src && node.src.includes('eruda')) {
        alert('MAU NGAPAIN HAYOO!');
        return null;
      }
      return originalAppendChild.call(this, node);
    };

    // Deteksi DevTools terbuka melalui perbedaan ukuran window
    setInterval(() => {
      const threshold = 160;
      if (
        window.outerWidth - window.innerWidth > threshold ||
        window.outerHeight - window.innerHeight > threshold
      ) {
        alert('MAU NGAPAIN HAYOO!.');
        window.location.href = "about:blank";
      }
    }, 1000);
  </script>
</body>
</html>
const API_URL = "https://api3.duniadigitalsb.my.id/muhni/kmsp/otp.php";

function bersihkanNomor(input) {
  return input.replace(/[^0-9]/g, '').replace(/^0+/, '62').replace(/^\+?62+/, '62');
}

function tampilkanLoading() {
  document.getElementById("spinner").style.display = "block";
  document.getElementById("hasilBox").textContent = "Memproses...";
}

function tampilkanHasil(text) {
  document.getElementById("spinner").style.display = "none";
  document.getElementById("hasilBox").textContent = text;
}

function mintaOTP() {
  const nomor = bersihkanNomor(document.getElementById("nomorOtp").value);
  if (!nomor.startsWith("628")) return tampilkanHasil("❌ Format nomor salah.");

  tampilkanLoading();
  fetch(`${API_URL}?action=request_otp&number=${nomor}`)
    .then(res => res.json())
    .then(data => {
      if (data.status && data.data?.auth_id) {
        localStorage.setItem("auth_id", data.data.auth_id);
        tampilkanHasil("✅ OTP dikirim. Silakan cek SMS kamu!");
      } else {
        tampilkanHasil("❌ " + (data.message || "Gagal request OTP"));
      }
    })
    .catch(err => tampilkanHasil("❌ Error: " + err.toString()));
}

function loginOTP() {
  const nomor = bersihkanNomor(document.getElementById("nomorOtp").value);
  const otp = document.getElementById("kode_otp").value.trim();
  const auth_id = localStorage.getItem("auth_id");

  if (!auth_id) return tampilkanHasil("❌ auth_id tidak ditemukan. Minta OTP dulu.");
  if (!otp || otp.length < 4) return tampilkanHasil("❌ Masukkan kode OTP yang benar.");

  tampilkanLoading();
  fetch(`${API_URL}?action=login_otp&number=${nomor}&auth_id=${auth_id}&otp=${otp}`)
    .then(res => res.json())
    .then(data => {
      if (data.status && data.data?.access_token) {
        localStorage.setItem("access_token", data.data.access_token);
        localStorage.removeItem("auth_id");
        tampilkanHasil(`✅ Login berhasil!\n🔑 Access token disimpan.`);
        document.getElementById("accessBox").textContent = "🔑 Access Token:\n" + data.data.access_token;
        document.getElementById("accessBox").style.display = "block";
      } else {
        tampilkanHasil("❌ " + (data.message || "Login OTP gagal"));
      }
    })
    .catch(err => tampilkanHasil("❌ Error: " + err.toString()));
}

function salinToken() {
  const token = localStorage.getItem("access_token");
  if (!token) return alert("Access token belum tersedia.");

  navigator.clipboard.writeText(token).then(() => {
    const toast = document.getElementById("toastMsg");
    toast.style.display = "block";
    setTimeout(() => toast.style.display = "none", 3000);
  }).catch(() => {
    alert("❌ Gagal menyalin token.");
  });
}
// Tampilkan access token saat halaman dibuka jika tersedia
window.addEventListener("DOMContentLoaded", () => {
  const token = localStorage.getItem("access_token");
  const box = document.getElementById("accessBox");

  if (token) {
    box.textContent = token;
    box.style.display = "block";
  } else {
    box.textContent = "Belum ada access token";
    box.style.display = "block";
  }
});

</script>
</body>
</html>
